name: Deploy to DigitalOcean

# åªæœ‰å½“æ¨é€åˆ° master åˆ†æ”¯æ—¶æ‰è§¦å‘
on:
  push:
    branches: [ "master" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        # ä½¿ç”¨è¿™ä¸ªç°æˆçš„ Action æ’ä»¶æ¥è¿æ¥ SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          # ğŸ‘‡ è¿™é‡Œå†™è¦åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œçš„å‘½ä»¤
          script: |
            echo "ğŸš€ GitHub Action: å¼€å§‹è‡ªåŠ¨éƒ¨ç½²..."
            
            # 1. è¿›å…¥é¡¹ç›®ç›®å½•
            cd ~/chat-community
            
            # 2. æ‹‰å–æœ€æ–°ä»£ç 
            git pull origin master
            
            # 3. é‡æ–°æ„å»ºå‰ç«¯ (å› ä¸ºæ²¡æœ‰çƒ­æ›´æ–°ï¼Œå¿…é¡»æ„å»º)
            echo "ğŸ“¦ æ„å»ºå‰ç«¯..."
            docker compose up -d --build client_builder
            
            # 4. é‡å¯åç«¯ (Devæ¨¡å¼ä¼šè‡ªåŠ¨çƒ­æ›´ï¼Œä½†é‡å¯ä¸€ä¸‹æ›´ç¨³å¦¥ï¼Œé˜²æ­¢ä¾èµ–å˜æ›´)
            echo "ğŸ”„ é‡å¯åç«¯..."
            docker compose restart api
            
            # 5. æ¸…ç†ä¸ç”¨çš„æ—§é•œåƒ (é˜²æ­¢ç¡¬ç›˜çˆ†æ»¡)
            docker image prune -f
            
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"