# å•ç‚¹ç™»å½•(SSO)åŠŸèƒ½è¯´æ˜

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

æœ¬ç³»ç»Ÿå·²å®ç°**å•ç‚¹ç™»å½•(Single Sign-On)**åŠŸèƒ½ï¼Œç¡®ä¿æ¯ä¸ªç”¨æˆ·è´¦å·**åŒæ—¶åªèƒ½åœ¨ä¸€ä¸ªè®¾å¤‡/æµè§ˆå™¨**ä¸Šç™»å½•ã€‚å½“ç”¨æˆ·åœ¨æ–°è®¾å¤‡ç™»å½•æ—¶ï¼Œæ—§è®¾å¤‡ä¼šè¢«è‡ªåŠ¨è¸¢å‡ºã€‚

---

## ğŸ” å·¥ä½œåŸç†

### 1. ç™»å½•æµç¨‹

```
ç”¨æˆ·ç™»å½• â†’ åˆ›å»ºä¼šè¯è®°å½• â†’ æ£€æŸ¥æ—§ä¼šè¯ â†’ åˆ é™¤æ—§ä¼šè¯ â†’ ä¿å­˜æ–°ä¼šè¯
```

**è¯¦ç»†æ­¥éª¤**:
1. ç”¨æˆ·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ç™»å½•
2. åç«¯éªŒè¯å‡­è¯åç”ŸæˆJWT token
3. åœ¨æ•°æ®åº“ä¸­åˆ›å»º`UserSession`è®°å½•ï¼ŒåŒ…å«:
   - Token (JWT)
   - IPåœ°å€
   - User-Agent (æµè§ˆå™¨/è®¾å¤‡ä¿¡æ¯)
   - è¿‡æœŸæ—¶é—´ (7å¤©)
   - Socket ID (WebSocketè¿æ¥ID)

4. å¦‚æœå‘ç°è¯¥ç”¨æˆ·æœ‰å…¶ä»–æ´»è·ƒä¼šè¯ï¼Œåˆ™åˆ é™¤æ—§ä¼šè¯è®°å½•

### 2. Socketè¿æ¥éªŒè¯

```
WebSocketè¿æ¥ â†’ éªŒè¯Token â†’ æ£€æŸ¥ä¼šè¯ â†’ æ£€æµ‹å†²çª â†’ è¸¢å‡ºæ—§è¿æ¥
```

**è¯¦ç»†æ­¥éª¤**:
1. å®¢æˆ·ç«¯ä½¿ç”¨Tokenå»ºç«‹WebSocketè¿æ¥
2. åç«¯éªŒè¯Tokençš„æœ‰æ•ˆæ€§
3. æŸ¥è¯¢æ•°æ®åº“ä¸­çš„ä¼šè¯è®°å½•
4. æ£€æŸ¥ä¼šè¯æ˜¯å¦è¿‡æœŸ
5. å¦‚æœå‘ç°åŒä¸€ç”¨æˆ·æœ‰å…¶ä»–æ´»è·ƒçš„Socketè¿æ¥:
   - å‘æ—§è¿æ¥å‘é€`forceLogout`äº‹ä»¶
   - æ—§è®¾å¤‡æ”¶åˆ°äº‹ä»¶åè‡ªåŠ¨ç™»å‡º
6. æ›´æ–°å½“å‰ä¼šè¯çš„Socket ID

### 3. æ–­å¼€è¿æ¥å¤„ç†

```
ç”¨æˆ·æ–­å¼€ â†’ æ¸…ç†Socket ID â†’ ä¿ç•™ä¼šè¯è®°å½•
```

- ç”¨æˆ·å…³é—­æµè§ˆå™¨/æ–­ç½‘æ—¶ï¼Œæ¸…é™¤ä¼šè¯ä¸­çš„Socket ID
- ä¿ç•™ä¼šè¯è®°å½•ç›´åˆ°è¿‡æœŸï¼ˆ7å¤©åï¼‰
- ç”¨æˆ·é‡æ–°æ‰“å¼€æµè§ˆå™¨å¯ä»¥è‡ªåŠ¨é‡è¿ï¼ˆå¦‚æœä¼šè¯æœªè¿‡æœŸï¼‰

### 4. ä¼šè¯æ¸…ç†

```
å®šæ—¶ä»»åŠ¡ â†’ æ£€æŸ¥è¿‡æœŸä¼šè¯ â†’ åˆ é™¤è¿‡æœŸè®°å½•
```

- æ¯å°æ—¶è‡ªåŠ¨æ‰§è¡Œä¸€æ¬¡
- åˆ é™¤æ‰€æœ‰è¿‡æœŸçš„ä¼šè¯è®°å½•
- é˜²æ­¢æ•°æ®åº“ä¸­å †ç§¯æ— ç”¨æ•°æ®

---

## ğŸ’» ç”¨æˆ·ä½“éªŒ

### åœºæ™¯1: æ­£å¸¸ç™»å½•

1. ç”¨æˆ·åœ¨è®¾å¤‡Aç™»å½• â†’ æˆåŠŸ
2. ç”¨æˆ·æ­£å¸¸ä½¿ç”¨

### åœºæ™¯2: å¤šè®¾å¤‡ç™»å½•

1. ç”¨æˆ·åœ¨è®¾å¤‡Aç™»å½• â†’ æˆåŠŸ
2. ç”¨æˆ·åœ¨è®¾å¤‡Bç™»å½• â†’ æˆåŠŸ
3. **è®¾å¤‡Aç«‹å³å¼¹å‡ºæç¤º**: "æ‚¨çš„è´¦å·åœ¨å…¶ä»–è®¾å¤‡ç™»å½•"
4. è®¾å¤‡Aè‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µ
5. è®¾å¤‡Bæ­£å¸¸ä½¿ç”¨

### åœºæ™¯3: é‡å¤ç™»å½•æ£€æµ‹

1. ç”¨æˆ·åœ¨åŒä¸€æµè§ˆå™¨å¤šä¸ªæ ‡ç­¾é¡µæ‰“å¼€åº”ç”¨
2. æ‰€æœ‰æ ‡ç­¾é¡µå…±äº«åŒä¸€ä¸ªä¼šè¯
3. ä¸ä¼šäº’ç›¸è¸¢å‡º

### åœºæ™¯4: ä¼šè¯è¿‡æœŸ

1. ç”¨æˆ·ç™»å½•å7å¤©æœªä½¿ç”¨
2. ä¼šè¯è‡ªåŠ¨è¿‡æœŸ
3. ç”¨æˆ·é‡æ–°æ‰“å¼€åº”ç”¨æ—¶éœ€è¦é‡æ–°ç™»å½•

---

## ğŸ—„ï¸ æ•°æ®åº“æ¶æ„

### UserSession è¡¨ç»“æ„

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `id` | String | ä¸»é”® |
| `userId` | String | ç”¨æˆ·IDï¼ˆå¤–é”®ï¼‰ |
| `token` | String | JWT Tokenï¼ˆå”¯ä¸€ï¼‰ |
| `socketId` | String? | WebSocketè¿æ¥IDï¼ˆå¯é€‰ï¼Œå”¯ä¸€ï¼‰ |
| `ipAddress` | String? | ç™»å½•IPåœ°å€ |
| `userAgent` | String? | æµè§ˆå™¨/è®¾å¤‡ä¿¡æ¯ |
| `lastActiveAt` | DateTime | æœ€åæ´»è·ƒæ—¶é—´ |
| `createdAt` | DateTime | åˆ›å»ºæ—¶é—´ |
| `expiresAt` | DateTime | è¿‡æœŸæ—¶é—´ |

**ç´¢å¼•**:
- `userId` - å¿«é€ŸæŸ¥æ‰¾ç”¨æˆ·çš„æ‰€æœ‰ä¼šè¯
- `token` - éªŒè¯Tokenæ—¶å¿«é€ŸæŸ¥è¯¢
- `expiresAt` - å®šæ—¶æ¸…ç†ä»»åŠ¡ä½¿ç”¨

---

## ğŸ”§ æŠ€æœ¯å®ç°

### åç«¯ç»„ä»¶

#### 1. Prisma Schema (`schema.prisma`)
```prisma
model UserSession {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token        String   @unique
  socketId     String?  @unique
  ipAddress    String?
  userAgent    String?
  lastActiveAt DateTime @default(now())
  createdAt    DateTime @default(now())
  expiresAt    DateTime

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}
```

#### 2. ç™»å½•æœåŠ¡ (`auth.service.ts`)
- åˆ›å»ºä¼šè¯è®°å½•
- åˆ é™¤æ—§ä¼šè¯
- è®°å½•IPå’ŒUser-Agent

#### 3. Socketä¸­é—´ä»¶ (`socket/index.ts`)
- éªŒè¯Tokenå’Œä¼šè¯
- æ£€æµ‹ä¼šè¯å†²çª
- è¸¢å‡ºæ—§è¿æ¥
- æ›´æ–°Socket ID

#### 4. ä¼šè¯æ¸…ç† (`sessionCleanupScheduler.ts`)
- å®šæ—¶åˆ é™¤è¿‡æœŸä¼šè¯
- æ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡
- è®°å½•æ¸…ç†æ—¥å¿—

### å‰ç«¯ç»„ä»¶

#### 1. SocketæœåŠ¡ (`socket.ts`)
- ç›‘å¬`forceLogout`äº‹ä»¶
- å¤„ç†è¢«è¸¢å‡ºé€»è¾‘
- æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
- è‡ªåŠ¨è·³è½¬ç™»å½•é¡µ

#### 2. è®¤è¯Store (`authStore`)
- æ¸…ç†æœ¬åœ°çŠ¶æ€
- åˆ é™¤Token
- é‡ç½®ç”¨æˆ·ä¿¡æ¯

---

## ğŸš€ éƒ¨ç½²æ³¨æ„äº‹é¡¹

### ç¯å¢ƒå˜é‡

ç¡®ä¿ä»¥ä¸‹ç¯å¢ƒå˜é‡æ­£ç¡®é…ç½®ï¼š

```env
# JWTå¯†é’¥ï¼ˆå¿…é¡»è®¾ç½®ï¼Œæ¨è64å­—ç¬¦ï¼‰
JWT_SECRET=your_super_secure_jwt_secret_key_here_64_characters_minimum

# æ•°æ®åº“è¿æ¥
DATABASE_URL=postgresql://user:password@localhost:5432/chat_community

# å®¢æˆ·ç«¯URLï¼ˆç”¨äºCORSï¼‰
CLIENT_URL=http://localhost:5173
```

### æ•°æ®åº“è¿ç§»

åˆæ¬¡éƒ¨ç½²æˆ–æ›´æ–°æ—¶è¿è¡Œè¿ç§»ï¼š

```bash
cd packages/api
pnpm prisma migrate deploy
```

### é›†ç¾¤æ¨¡å¼æ³¨æ„

å¦‚æœä½¿ç”¨å¤šä¸ªæœåŠ¡å™¨å®ä¾‹ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰ï¼Œéœ€è¦ç¡®ä¿ï¼š

1. **å…±äº«æ•°æ®åº“**: æ‰€æœ‰å®ä¾‹è¿æ¥åŒä¸€ä¸ªPostgreSQLæ•°æ®åº“
2. **Rediså…±äº«**: è€ƒè™‘ä½¿ç”¨Rediså­˜å‚¨Socket.ioä¼šè¯ï¼ˆå¯é€‰ä¼˜åŒ–ï¼‰
3. **ç²˜æ€§ä¼šè¯**: é…ç½®è´Ÿè½½å‡è¡¡å™¨ä½¿ç”¨ç²˜æ€§ä¼šè¯ï¼ˆsticky sessionsï¼‰

**Nginxé…ç½®ç¤ºä¾‹**:
```nginx
upstream chat_backend {
    ip_hash;  # ç²˜æ€§ä¼šè¯
    server 127.0.0.1:3000;
    server 127.0.0.1:3001;
}
```

---

## ğŸ§ª æµ‹è¯•åœºæ™¯

### æ‰‹åŠ¨æµ‹è¯•

1. **åŸºæœ¬å•ç‚¹ç™»å½•**:
   - åœ¨Chromeç™»å½•
   - åœ¨Firefoxç™»å½•
   - éªŒè¯Chromeè¢«è¸¢å‡º

2. **å¤šæ ‡ç­¾é¡µæµ‹è¯•**:
   - åœ¨Chromeæ‰“å¼€å¤šä¸ªæ ‡ç­¾é¡µ
   - éªŒè¯ä¸ä¼šäº’ç›¸è¸¢å‡º
   - åœ¨å¦ä¸€ä¸ªæµè§ˆå™¨ç™»å½•
   - éªŒè¯æ‰€æœ‰Chromeæ ‡ç­¾é¡µéƒ½è¢«è¸¢å‡º

3. **é‡è¿æµ‹è¯•**:
   - ç™»å½•åæ–­ç½‘
   - ç­‰å¾…10ç§’
   - æ¢å¤ç½‘ç»œ
   - éªŒè¯è‡ªåŠ¨é‡è¿ï¼ˆä¸è¢«è¸¢å‡ºï¼‰

4. **è¿‡æœŸæµ‹è¯•**:
   - ç™»å½•
   - æ‰‹åŠ¨ä¿®æ”¹æ•°æ®åº“ä¸­çš„`expiresAt`ä¸ºè¿‡å»æ—¶é—´
   - åˆ·æ–°é¡µé¢
   - éªŒè¯éœ€è¦é‡æ–°ç™»å½•

### è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬

```bash
# æµ‹è¯•ä¼šè¯æ¸…ç†
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"test","password":"password"}'

# æ£€æŸ¥æ•°æ®åº“
psql -d chat_community -c "SELECT * FROM \"UserSession\";"
```

---

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### å…³é”®æ—¥å¿—

æŸ¥çœ‹ä¼šè¯ç›¸å…³æ—¥å¿—ï¼š

```bash
# ç™»å½•æ—¥å¿—
grep "logged in from new device" logs/combined.log

# ä¼šè¯æ¸…ç†æ—¥å¿—
grep "Cleaned up.*sessions" logs/combined.log

# å¼ºåˆ¶ç™»å‡ºæ—¥å¿—
grep "Force logout" logs/combined.log
```

### æ•°æ®åº“æŸ¥è¯¢

```sql
-- æŸ¥çœ‹æ‰€æœ‰æ´»è·ƒä¼šè¯
SELECT u.username, s.* 
FROM "UserSession" s
JOIN "User" u ON s."userId" = u.id
WHERE s."expiresAt" > NOW()
ORDER BY s."lastActiveAt" DESC;

-- ç»Ÿè®¡æ¯ä¸ªç”¨æˆ·çš„ä¼šè¯æ•°
SELECT u.username, COUNT(s.id) as session_count
FROM "User" u
LEFT JOIN "UserSession" s ON u.id = s."userId" AND s."expiresAt" > NOW()
GROUP BY u.id, u.username
ORDER BY session_count DESC;

-- æŸ¥æ‰¾è¿‡æœŸä¼šè¯
SELECT COUNT(*) as expired_count
FROM "UserSession"
WHERE "expiresAt" < NOW();
```

---

## âš ï¸ å·²çŸ¥é™åˆ¶

1. **æµè§ˆå™¨éšç§æ¨¡å¼**: æ¯ä¸ªéšç§çª—å£è¢«è§†ä¸ºç‹¬ç«‹è®¾å¤‡
2. **åŒæµè§ˆå™¨å¤šè´¦å·**: éœ€è¦ä½¿ç”¨ä¸åŒæµè§ˆå™¨æˆ–éšç§æ¨¡å¼
3. **ä¼šè¯åŒæ­¥å»¶è¿Ÿ**: è¸¢å‡ºæ“ä½œä¾èµ–WebSocketï¼Œå¦‚æœç½‘ç»œå»¶è¿Ÿå¯èƒ½æœ‰1-2ç§’å»¶è¿Ÿ
4. **Tokenè¿‡æœŸä¸åŒæ­¥**: JWTè¿‡æœŸæ—¶é—´å’Œæ•°æ®åº“ä¼šè¯è¿‡æœŸæ—¶é—´éœ€è¦ä¿æŒä¸€è‡´ï¼ˆå½“å‰éƒ½æ˜¯7å¤©ï¼‰

---

## ğŸ”„ æœªæ¥ä¼˜åŒ–

### å¯é€‰åŠŸèƒ½

1. **å¤šè®¾å¤‡ç®¡ç†**:
   - å…è®¸ç”¨æˆ·æŸ¥çœ‹æ‰€æœ‰æ´»è·ƒè®¾å¤‡
   - æ‰‹åŠ¨è¸¢å‡ºæŒ‡å®šè®¾å¤‡
   - ä¿¡ä»»è®¾å¤‡åˆ—è¡¨

2. **ä¼šè¯é€šçŸ¥**:
   - æ–°è®¾å¤‡ç™»å½•æ—¶å‘é€é‚®ä»¶/çŸ­ä¿¡é€šçŸ¥
   - æ˜¾ç¤ºç™»å½•è®¾å¤‡ä¿¡æ¯ï¼ˆIPã€åœ°åŒºã€è®¾å¤‡ç±»å‹ï¼‰

3. **çµæ´»ä¼šè¯ç­–ç•¥**:
   - å…è®¸ç®¡ç†å‘˜é…ç½®æœ€å¤§åŒæ—¶ç™»å½•è®¾å¤‡æ•°
   - ä¸åŒç”¨æˆ·è§’è‰²ä¸åŒç­–ç•¥ï¼ˆæ™®é€šç”¨æˆ·1ä¸ªï¼ŒVIPç”¨æˆ·3ä¸ªï¼‰

4. **Redisä¼˜åŒ–**:
   - ä½¿ç”¨Rediså­˜å‚¨æ´»è·ƒä¼šè¯
   - å‡å°‘æ•°æ®åº“æŸ¥è¯¢å‹åŠ›
   - æ›´å¿«çš„ä¼šè¯éªŒè¯

### é…ç½®é€‰é¡¹

```env
# æœªæ¥å¯é…ç½®é¡¹
MAX_CONCURRENT_SESSIONS=1  # æœ€å¤§åŒæ—¶ä¼šè¯æ•°
SESSION_EXPIRE_DAYS=7      # ä¼šè¯è¿‡æœŸå¤©æ•°
ENABLE_SESSION_NOTIFICATION=true  # æ–°ç™»å½•é€šçŸ¥
```

---

## ğŸ“š ç›¸å…³æ–‡ä»¶

### åç«¯
- `packages/api/prisma/schema.prisma` - æ•°æ®åº“æ¨¡å‹
- `packages/api/src/services/auth.service.ts` - ç™»å½•é€»è¾‘
- `packages/api/src/controllers/auth.controller.ts` - ç™»å½•æ§åˆ¶å™¨
- `packages/api/src/socket/index.ts` - WebSocketè®¤è¯
- `packages/api/src/utils/sessionCleanupScheduler.ts` - ä¼šè¯æ¸…ç†
- `packages/api/src/server.ts` - æœåŠ¡å™¨å¯åŠ¨

### å‰ç«¯
- `packages/client/src/lib/socket.ts` - SocketæœåŠ¡
- `packages/client/src/stores/authStore.ts` - è®¤è¯çŠ¶æ€ç®¡ç†

### è¿ç§»
- `packages/api/prisma/migrations/20251115225341_add_user_sessions/` - æ•°æ®åº“è¿ç§»

---

## ğŸ’¡ å¸¸è§é—®é¢˜

### Q: ä¸ºä»€ä¹ˆåŒä¸€æµè§ˆå™¨å¤šä¸ªæ ‡ç­¾é¡µä¸ä¼šäº’ç›¸è¸¢å‡ºï¼Ÿ
**A**: åŒä¸€æµè§ˆå™¨çš„å¤šä¸ªæ ‡ç­¾é¡µå…±äº«ç›¸åŒçš„localStorageå’ŒTokenï¼Œä½¿ç”¨åŒä¸€ä¸ªä¼šè¯ï¼Œå› æ­¤ä¸ä¼šå†²çªã€‚

### Q: ç”¨æˆ·å…³é—­æµè§ˆå™¨åä¼šè¯ä¼šç«‹å³å¤±æ•ˆå—ï¼Ÿ
**A**: ä¸ä¼šã€‚ä¼šè¯ä¼šä¿ç•™7å¤©ï¼Œç”¨æˆ·é‡æ–°æ‰“å¼€æµè§ˆå™¨å¯ä»¥è‡ªåŠ¨é‡è¿ã€‚å¦‚æœéœ€è¦ç«‹å³å¤±æ•ˆï¼Œéœ€è¦ç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»"é€€å‡ºç™»å½•"ã€‚

### Q: å¦‚ä½•å¼ºåˆ¶æ‰€æœ‰ç”¨æˆ·é‡æ–°ç™»å½•ï¼Ÿ
**A**: æ‰§è¡ŒSQLåˆ é™¤æ‰€æœ‰ä¼šè¯ï¼š
```sql
DELETE FROM "UserSession";
```
æˆ–é‡å¯æœåŠ¡å™¨å¹¶ä¿®æ”¹`JWT_SECRET`ç¯å¢ƒå˜é‡ã€‚

### Q: ä¼šè¯æ¸…ç†ä»»åŠ¡ä¼šå½±å“æ€§èƒ½å—ï¼Ÿ
**A**: ä¸ä¼šã€‚æ¸…ç†ä»»åŠ¡ä½¿ç”¨ç´¢å¼•æŸ¥è¯¢ï¼Œæ¯å°æ—¶ä»…æ‰§è¡Œä¸€æ¬¡ï¼Œä¸”é€šå¸¸åªåˆ é™¤å°‘é‡è¿‡æœŸè®°å½•ã€‚

### Q: æ˜¯å¦æ”¯æŒ"è®°ä½æˆ‘"åŠŸèƒ½ï¼Ÿ
**A**: å½“å‰ä¼šè¯é»˜è®¤7å¤©æœ‰æ•ˆï¼Œç›¸å½“äº"è®°ä½æˆ‘"åŠŸèƒ½ã€‚æœªæ¥å¯ä»¥é€šè¿‡è°ƒæ•´`expiresAt`æ—¶é•¿æ¥æ”¯æŒæ›´çµæ´»çš„é…ç½®ã€‚

---

## ğŸ¯ æœ€ä½³å®è·µ

1. **ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä¿®æ”¹JWT_SECRET**: ä½¿ç”¨å¼ºéšæœºå­—ç¬¦ä¸²ï¼Œè‡³å°‘64ä½
2. **å®šæœŸå¤‡ä»½ä¼šè¯æ•°æ®**: è™½ç„¶ä¼šè¯å¯é‡æ–°åˆ›å»ºï¼Œä½†å¤‡ä»½æœ‰åŠ©äºå®¡è®¡
3. **ç›‘æ§å¼‚å¸¸ç™»å½•**: å…³æ³¨çŸ­æ—¶é—´å†…å¤šæ¬¡å¼ºåˆ¶ç™»å‡ºçš„ç”¨æˆ·
4. **è®¾ç½®IPç™½åå•**: å¯é€‰åœ°é™åˆ¶ç‰¹å®šIPèŒƒå›´ç™»å½•
5. **å¯ç”¨HTTPS**: ç¡®ä¿Tokenä¼ è¾“å®‰å…¨

---

æœ€åæ›´æ–°: 2025å¹´11æœˆ15æ—¥
ç‰ˆæœ¬: 1.0.0
