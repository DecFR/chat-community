# Chat & Community - 测试指南

## 🚀 快速开始

### 1. 启动服务

确保 PostgreSQL 数据库已运行，然后启动项目：

```bash
# 在项目根目录
pnpm run dev
```

这将同时启动：
- **后端服务器**: http://localhost:3000
- **前端应用**: http://localhost:5173

### 2. 访问应用

在浏览器中打开 http://localhost:5173

---

## 📋 功能测试清单

### ✅ 认证功能测试

#### 注册新用户
1. 点击"注册"按钮
2. 输入用户名（至少 3 个字符）
3. 输入密码（至少 6 个字符）
4. 可选：输入邮箱地址
5. 点击"注册"按钮

**预期结果**：
- 第一个注册的用户自动成为 ADMIN 角色
- 成功后自动跳转到主界面
- Socket.IO 自动连接

#### 登录测试
1. 输入已注册的用户名和密码
2. 点击"登录"按钮

**预期结果**：
- 成功登录后跳转到主界面
- JWT Token 存储在 localStorage
- 用户状态显示为"在线"

#### 登出测试
1. 点击用户头像/设置按钮
2. 选择"登出"

**预期结果**：
- 清除本地 Token
- Socket.IO 断开连接
- 跳转到登录页面

---

### 🏰 服务器功能测试

#### 创建服务器
1. 点击左侧"+"按钮
2. 输入服务器名称（必填）
3. 输入服务器描述（可选）
4. 点击"创建"

**预期结果**：
- 服务器出现在左侧列表
- 自动创建一个默认的"general"频道
- 创建者成为 OWNER 角色

#### 创建频道
1. 选择一个服务器
2. 点击频道列表上方的"+"按钮
3. 选择频道类型（文字/语音）
4. 输入频道名称
5. 点击"创建"

**预期结果**：
- 频道出现在频道列表中
- 文字频道以"#"开头
- 语音频道以"🔊"开头

#### 编辑/删除服务器
1. 右键点击服务器图标
2. 选择"编辑"或"删除"

**预期结果**：
- 只有 OWNER 和 ADMIN 可以删除服务器
- 删除服务器会同时删除所有频道和消息

---

### 👥 好友系统测试

#### 搜索用户
1. 点击顶部搜索按钮
2. 输入用户名
3. 点击"搜索"

**预期结果**：
- 显示匹配的用户列表
- 显示用户头像、用户名、简介、在线状态

#### 发送好友请求
1. 搜索到目标用户
2. 点击用户卡片
3. 点击"添加好友"按钮

**预期结果**：
- 发送好友请求
- 对方收到通知

#### 处理好友请求
1. 点击"好友请求"标签
2. 查看待处理请求
3. 点击"接受"或"拒绝"

**预期结果**：
- 接受后双方成为好友
- 可以开始私聊
- 在好友列表中显示

#### 移除好友
1. 右键点击好友
2. 选择"移除好友"

**预期结果**：
- 好友关系解除
- 从好友列表移除
- 聊天记录保留

---

### 💬 消息功能测试

#### 发送频道消息
1. 选择一个文字频道
2. 在底部输入框输入消息
3. 按 Enter 或点击发送按钮

**预期结果**：
- 消息立即显示在聊天窗口
- 消息经过 AES-256-GCM 加密存储
- 其他在线成员实时收到消息

#### 发送私聊消息
1. 点击主页按钮（Home）
2. 选择一个好友
3. 输入并发送消息

**预期结果**：
- 创建私聊对话
- 消息加密传输
- 对方实时收到消息

#### 输入状态指示
1. 在输入框输入文字（不发送）
2. 观察对方视角

**预期结果**：
- 对方看到"XXX 正在输入..."
- 停止输入 3 秒后状态消失

#### 消息历史加载
1. 滚动到聊天窗口顶部
2. 观察历史消息加载

**预期结果**：
- 自动加载更早的消息
- 每次加载 50 条
- 支持无限滚动

---

### ⚙️ 用户设置测试

#### 修改个人资料
1. 点击用户头像打开设置
2. 在"个人资料"标签：
   - 修改显示名称
   - 修改邮箱
   - 修改个人简介
3. 点击"保存更改"

**预期结果**：
- 资料更新成功
- 其他用户看到更新后的信息

#### 上传头像
1. 在设置中点击头像上的相机图标
2. 选择图片文件
3. 点击"保存更改"

**预期结果**：
- 头像上传到服务器（/uploads 目录）
- 头像实时更新显示

#### 切换主题
1. 进入"外观设置"标签
2. 选择主题：
   - 暗色
   - 亮色
   - 跟随系统
3. 点击"保存更改"

**预期结果**：
- 主题立即应用
- 设置持久化保存

#### 隐私设置
1. 进入"隐私设置"标签
2. 修改"好友请求隐私"：
   - 所有人
   - 好友的好友
   - 关闭
3. 点击"保存更改"

**预期结果**：
- 设置生效
- 影响谁可以向你发送好友请求

---

### 🔔 通知系统测试

#### 接收通知
观察以下场景下的通知：
- 收到好友请求
- 收到新消息
- 被 @提及
- 收到服务器邀请

**预期结果**：
- 通知铃铛显示未读数量
- 点击查看通知详情
- 支持标记已读

---

### 🎯 在线状态测试

#### 状态同步
1. 打开两个浏览器窗口（不同用户）
2. 观察在线状态变化

**预期结果**：
- 登录后状态变为"在线"（绿色）
- 登出后状态变为"离线"（灰色）
- 状态实时同步到所有客户端

#### 多设备支持
1. 同一用户在两个浏览器登录
2. 发送消息

**预期结果**：
- 两个设备都能收到消息
- Socket.IO 支持多连接

---

## 🔐 安全功能测试

### 消息加密验证
1. 查看数据库中的 Message 表
2. 检查 `encryptedContent` 字段

**预期结果**：
- 消息内容不是明文
- 格式为 JSON: `{iv, encryptedData, authTag}`
- 使用 AES-256-GCM 加密

### JWT 认证测试
1. 打开浏览器开发者工具
2. 查看 Network 标签
3. 观察 API 请求

**预期结果**：
- 所有请求携带 Authorization Bearer Token
- Token 过期后自动跳转登录页面
- 刷新页面后保持登录状态

---

## 🐛 错误处理测试

### 网络错误
1. 断开网络连接
2. 尝试发送消息

**预期结果**：
- 显示友好错误提示
- Socket.IO 自动重连

### 服务器错误
1. 停止后端服务器
2. 尝试操作

**预期结果**：
- 显示"无法连接到服务器"
- 不会导致应用崩溃

### 验证错误
1. 尝试创建空名称的服务器
2. 尝试发送空消息

**预期结果**：
- 前端验证拦截
- 显示清晰的错误提示

---

## 🔍 数据库验证

### 检查数据表
```bash
# 进入 API 目录
cd packages/api

# 打开 Prisma Studio
npx prisma studio
```

浏览器会打开 http://localhost:5555，可以查看：
- User 表：用户数据
- Message 表：加密的消息（检查 encryptedContent）
- Friendship 表：好友关系
- Server 表：服务器数据
- Channel 表：频道数据
- UserConversationState 表：阅读状态

---

## 📊 性能测试

### 消息加载性能
1. 创建大量消息（100+ 条）
2. 滚动聊天窗口

**预期表现**：
- 分页加载，每次 50 条
- 滚动流畅，无卡顿
- 内存占用稳定

### 多用户并发
1. 模拟 10+ 用户同时在线
2. 同时发送消息

**预期表现**：
- 消息实时送达
- Socket.IO 连接稳定
- 无消息丢失

---

## 🎨 UI/UX 测试

### 响应式设计
1. 调整浏览器窗口大小
2. 使用移动设备访问

**预期表现**：
- 布局自适应
- 所有功能可用
- 无元素溢出或重叠

### 主题一致性
检查所有页面是否使用：
- Discord 配色方案
- 统一的字体和间距
- 流畅的过渡动画

---

## 📝 日志和调试

### 查看服务器日志
```bash
# 后端控制台会显示：
# - HTTP 请求日志
# - Socket.IO 连接/断开
# - 数据库查询（开发模式）
# - 错误堆栈
```

### 查看客户端日志
打开浏览器控制台：
- Network：查看 API 请求和响应
- Console：查看 Socket.IO 事件
- Application：查看 localStorage 中的 Token

---

## 🔧 常见问题排查

### 问题：无法连接到数据库
**解决方案**：
1. 检查 PostgreSQL 是否运行
2. 验证 .env 中的 DATABASE_URL
3. 确认数据库密码正确

### 问题：Socket.IO 连接失败
**解决方案**：
1. 检查后端是否启动（端口 3000）
2. 查看浏览器控制台的 WebSocket 连接
3. 确认 Token 有效

### 问题：消息无法解密
**解决方案**：
1. 检查 ENCRYPTION_KEY 是否为 64 位十六进制
2. 确保前后端使用相同的密钥
3. 查看服务器日志的解密错误

---

## ✅ 测试检查清单

- [ ] 用户注册和登录
- [ ] 创建和管理服务器
- [ ] 创建和管理频道
- [ ] 添加和移除好友
- [ ] 发送和接收消息
- [ ] 消息加密工作正常
- [ ] 在线状态同步
- [ ] 输入状态显示
- [ ] 通知功能
- [ ] 用户设置保存
- [ ] 头像上传
- [ ] 主题切换
- [ ] 隐私设置
- [ ] 错误处理
- [ ] Socket.IO 重连
- [ ] 刷新后保持登录
- [ ] 响应式布局

---

## 🎓 技术架构说明

### 前端技术栈
- **React 19** + TypeScript
- **Vite** 构建工具
- **Tailwind CSS** 样式
- **Zustand** 状态管理
- **React Router** 路由
- **Axios** HTTP 客户端
- **Socket.IO Client** 实时通信

### 后端技术栈
- **Node.js 20+** + Express.js
- **TypeScript**
- **Prisma ORM** + PostgreSQL
- **Socket.IO** WebSocket
- **JWT** 认证
- **bcrypt** 密码加密
- **crypto** 消息加密（AES-256-GCM）

### 数据库模型
```
User (用户)
  ├── UserSettings (设置)
  ├── Friendship (好友关系)
  ├── ServerMember (服务器成员)
  └── Message (消息)

Server (服务器)
  ├── Channel (频道)
  └── ServerMember (成员)

Message (消息)
  ├── Channel (频道消息)
  └── DirectMessageConversation (私聊)

UserConversationState (阅读状态)
```

---

## 📞 获取帮助

如果遇到问题：
1. 查看浏览器控制台错误
2. 查看服务器终端日志
3. 检查数据库连接
4. 验证环境变量配置

**祝测试顺利！** 🎉
